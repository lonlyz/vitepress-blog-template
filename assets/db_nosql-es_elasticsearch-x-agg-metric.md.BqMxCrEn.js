import{_ as n,c as a,ai as p,o as t}from"./chunks/framework.BrYByd3F.js";const e="/vitepress-blog-template/images/db/es/es-agg-metric-1.png",h=JSON.parse('{"title":"ES详解 - 聚合：聚合查询之Metric聚合详解","description":"","frontmatter":{},"headers":[],"relativePath":"db/nosql-es/elasticsearch-x-agg-metric.md","filePath":"db/nosql-es/elasticsearch-x-agg-metric.md","lastUpdated":1737706346000}'),l={name:"db/nosql-es/elasticsearch-x-agg-metric.md"};function o(i,s,u,c,q,d){return t(),a("div",null,s[0]||(s[0]=[p('<h1 id="es详解-聚合-聚合查询之metric聚合详解" tabindex="-1">ES详解 - 聚合：聚合查询之Metric聚合详解 <a class="header-anchor" href="#es详解-聚合-聚合查询之metric聚合详解" aria-label="Permalink to &quot;ES详解 - 聚合：聚合查询之Metric聚合详解&quot;">​</a></h1><blockquote><p>前文主要讲了 ElasticSearch提供的三种聚合方式之<strong>桶聚合（Bucket Aggregation)</strong>，本文主要讲讲<strong>指标聚合（Metric Aggregation)</strong>。@pdai</p></blockquote><h2 id="如何理解metric聚合" tabindex="-1">如何理解metric聚合 <a class="header-anchor" href="#如何理解metric聚合" aria-label="Permalink to &quot;如何理解metric聚合&quot;">​</a></h2><blockquote><p>在<a href="https://pdai.tech/md/db/nosql-es/elasticsearch-x-agg-bucket.html" target="_blank" rel="noreferrer">bucket聚合</a>中，我画了一张图辅助你构筑体系，那么metric聚合又如何理解呢？</p></blockquote><p>如果你直接去看官方文档，大概也有十几种：</p><p><img src="'+e+`" alt=""></p><blockquote><p>那么metric聚合又如何理解呢？我认为从两个角度：</p></blockquote><ul><li><strong>从分类看</strong>：Metric聚合分析分为<strong>单值分析</strong>和<strong>多值分析</strong>两类</li><li><strong>从功能看</strong>：根据具体的应用场景设计了一些分析api, 比如地理位置，百分数等等</li></ul><blockquote><p>融合上述两个方面，我们可以梳理出大致的一个mind图：</p></blockquote><ul><li><strong>单值分析</strong>: 只输出一个分析结果 <ul><li>标准stat型 <ul><li><code>avg</code> 平均值</li><li><code>max</code> 最大值</li><li><code>min</code> 最小值</li><li><code>sum</code> 和</li><li><code>value_count</code> 数量</li></ul></li><li>其它类型 <ul><li><code>cardinality</code> 基数（distinct去重）</li><li><code>weighted_avg</code> 带权重的avg</li><li><code>median_absolute_deviation</code> 中位值</li></ul></li></ul></li><li><strong>多值分析</strong>: 单值之外的 <ul><li>stats型 <ul><li><code>stats</code> 包含avg,max,min,sum和count</li><li><code>matrix_stats</code> 针对矩阵模型</li><li><code>extended_stats</code></li><li><code>string_stats</code> 针对字符串</li></ul></li><li>百分数型 <ul><li><code>percentiles</code> 百分数范围</li><li><code>percentile_ranks</code> 百分数排行</li></ul></li><li>地理位置型 <ul><li><code>geo_bounds</code> Geo bounds</li><li><code>geo_centroid</code> Geo-centroid</li><li><code>geo_line</code> Geo-Line</li></ul></li><li>Top型 <ul><li><code>top_hits</code> 分桶后的top hits</li><li><code>top_metrics</code></li></ul></li></ul></li></ul><blockquote><p><strong>通过上述列表（我就不画图了），我们构筑的体系是基于<code>分类</code>和<code>功能</code>，而不是具体的项（比如avg,percentiles...)；这是不同的认知维度: 具体的项是碎片化，分类和功能这种是你需要构筑的体系</strong>。@pdai</p></blockquote><h2 id="单值分析-标准stat类型" tabindex="-1">单值分析: 标准stat类型 <a class="header-anchor" href="#单值分析-标准stat类型" aria-label="Permalink to &quot;单值分析: 标准stat类型&quot;">​</a></h2><h3 id="avg-平均值" tabindex="-1"><code>avg</code> 平均值 <a class="header-anchor" href="#avg-平均值" aria-label="Permalink to &quot;\`avg\` 平均值&quot;">​</a></h3><p>计算班级的平均分</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /exams/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;avg_grade&quot;: { &quot;avg&quot;: { &quot;field&quot;: &quot;grade&quot; } }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;avg_grade&quot;: {</span></span>
<span class="line"><span>      &quot;value&quot;: 75.0</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="max-最大值" tabindex="-1"><code>max</code> 最大值 <a class="header-anchor" href="#max-最大值" aria-label="Permalink to &quot;\`max\` 最大值&quot;">​</a></h3><p>计算销售最高价</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /sales/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;max_price&quot;: { &quot;max&quot;: { &quot;field&quot;: &quot;price&quot; } }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>      &quot;max_price&quot;: {</span></span>
<span class="line"><span>          &quot;value&quot;: 200.0</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="min-最小值" tabindex="-1"><code>min</code> 最小值 <a class="header-anchor" href="#min-最小值" aria-label="Permalink to &quot;\`min\` 最小值&quot;">​</a></h3><p>计算销售最低价</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /sales/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;min_price&quot;: { &quot;min&quot;: { &quot;field&quot;: &quot;price&quot; } }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;min_price&quot;: {</span></span>
<span class="line"><span>      &quot;value&quot;: 10.0</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="sum-和" tabindex="-1"><code>sum</code> 和 <a class="header-anchor" href="#sum-和" aria-label="Permalink to &quot;\`sum\` 和&quot;">​</a></h3><p>计算销售总价</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /sales/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;query&quot;: {</span></span>
<span class="line"><span>    &quot;constant_score&quot;: {</span></span>
<span class="line"><span>      &quot;filter&quot;: {</span></span>
<span class="line"><span>        &quot;match&quot;: { &quot;type&quot;: &quot;hat&quot; }</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  },</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;hat_prices&quot;: { &quot;sum&quot;: { &quot;field&quot;: &quot;price&quot; } }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;hat_prices&quot;: {</span></span>
<span class="line"><span>      &quot;value&quot;: 450.0</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="value-count-数量" tabindex="-1"><code>value_count</code> 数量 <a class="header-anchor" href="#value-count-数量" aria-label="Permalink to &quot;\`value_count\` 数量&quot;">​</a></h3><p>销售数量统计</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /sales/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot; : {</span></span>
<span class="line"><span>    &quot;types_count&quot; : { &quot;value_count&quot; : { &quot;field&quot; : &quot;type&quot; } }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;types_count&quot;: {</span></span>
<span class="line"><span>      &quot;value&quot;: 7</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="单值分析-其它类型" tabindex="-1">单值分析: 其它类型 <a class="header-anchor" href="#单值分析-其它类型" aria-label="Permalink to &quot;单值分析: 其它类型&quot;">​</a></h2><h3 id="weighted-avg-带权重的avg" tabindex="-1"><code>weighted_avg</code> 带权重的avg <a class="header-anchor" href="#weighted-avg-带权重的avg" aria-label="Permalink to &quot;\`weighted_avg\` 带权重的avg&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /exams/_search</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;size&quot;: 0,</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;weighted_grade&quot;: {</span></span>
<span class="line"><span>      &quot;weighted_avg&quot;: {</span></span>
<span class="line"><span>        &quot;value&quot;: {</span></span>
<span class="line"><span>          &quot;field&quot;: &quot;grade&quot;</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        &quot;weight&quot;: {</span></span>
<span class="line"><span>          &quot;field&quot;: &quot;weight&quot;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;weighted_grade&quot;: {</span></span>
<span class="line"><span>      &quot;value&quot;: 70.0</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="cardinality-基数-distinct去重" tabindex="-1"><code>cardinality</code> 基数（distinct去重） <a class="header-anchor" href="#cardinality-基数-distinct去重" aria-label="Permalink to &quot;\`cardinality\` 基数（distinct去重）&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /sales/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;type_count&quot;: {</span></span>
<span class="line"><span>      &quot;cardinality&quot;: {</span></span>
<span class="line"><span>        &quot;field&quot;: &quot;type&quot;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;type_count&quot;: {</span></span>
<span class="line"><span>      &quot;value&quot;: 3</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="median-absolute-deviation-中位值" tabindex="-1"><code>median_absolute_deviation</code> 中位值 <a class="header-anchor" href="#median-absolute-deviation-中位值" aria-label="Permalink to &quot;\`median_absolute_deviation\` 中位值&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GET reviews/_search</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;size&quot;: 0,</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;review_average&quot;: {</span></span>
<span class="line"><span>      &quot;avg&quot;: {</span></span>
<span class="line"><span>        &quot;field&quot;: &quot;rating&quot;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    &quot;review_variability&quot;: {</span></span>
<span class="line"><span>      &quot;median_absolute_deviation&quot;: {</span></span>
<span class="line"><span>        &quot;field&quot;: &quot;rating&quot; </span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;review_average&quot;: {</span></span>
<span class="line"><span>      &quot;value&quot;: 3.0</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    &quot;review_variability&quot;: {</span></span>
<span class="line"><span>      &quot;value&quot;: 2.0</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="非单值分析-stats型" tabindex="-1">非单值分析：stats型 <a class="header-anchor" href="#非单值分析-stats型" aria-label="Permalink to &quot;非单值分析：stats型&quot;">​</a></h2><h3 id="stats-包含avg-max-min-sum和count" tabindex="-1"><code>stats</code> 包含avg,max,min,sum和count <a class="header-anchor" href="#stats-包含avg-max-min-sum和count" aria-label="Permalink to &quot;\`stats\` 包含avg,max,min,sum和count&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /exams/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;grades_stats&quot;: { &quot;stats&quot;: { &quot;field&quot;: &quot;grade&quot; } }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;grades_stats&quot;: {</span></span>
<span class="line"><span>      &quot;count&quot;: 2,</span></span>
<span class="line"><span>      &quot;min&quot;: 50.0,</span></span>
<span class="line"><span>      &quot;max&quot;: 100.0,</span></span>
<span class="line"><span>      &quot;avg&quot;: 75.0,</span></span>
<span class="line"><span>      &quot;sum&quot;: 150.0</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="matrix-stats-针对矩阵模型" tabindex="-1"><code>matrix_stats</code> 针对矩阵模型 <a class="header-anchor" href="#matrix-stats-针对矩阵模型" aria-label="Permalink to &quot;\`matrix_stats\` 针对矩阵模型&quot;">​</a></h3><p>以下示例说明了使用矩阵统计量来描述收入与贫困之间的关系。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GET /_search</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;statistics&quot;: {</span></span>
<span class="line"><span>      &quot;matrix_stats&quot;: {</span></span>
<span class="line"><span>        &quot;fields&quot;: [ &quot;poverty&quot;, &quot;income&quot; ]</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;statistics&quot;: {</span></span>
<span class="line"><span>      &quot;doc_count&quot;: 50,</span></span>
<span class="line"><span>      &quot;fields&quot;: [ {</span></span>
<span class="line"><span>          &quot;name&quot;: &quot;income&quot;,</span></span>
<span class="line"><span>          &quot;count&quot;: 50,</span></span>
<span class="line"><span>          &quot;mean&quot;: 51985.1,</span></span>
<span class="line"><span>          &quot;variance&quot;: 7.383377037755103E7,</span></span>
<span class="line"><span>          &quot;skewness&quot;: 0.5595114003506483,</span></span>
<span class="line"><span>          &quot;kurtosis&quot;: 2.5692365287787124,</span></span>
<span class="line"><span>          &quot;covariance&quot;: {</span></span>
<span class="line"><span>            &quot;income&quot;: 7.383377037755103E7,</span></span>
<span class="line"><span>            &quot;poverty&quot;: -21093.65836734694</span></span>
<span class="line"><span>          },</span></span>
<span class="line"><span>          &quot;correlation&quot;: {</span></span>
<span class="line"><span>            &quot;income&quot;: 1.0,</span></span>
<span class="line"><span>            &quot;poverty&quot;: -0.8352655256272504</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>        }, {</span></span>
<span class="line"><span>          &quot;name&quot;: &quot;poverty&quot;,</span></span>
<span class="line"><span>          &quot;count&quot;: 50,</span></span>
<span class="line"><span>          &quot;mean&quot;: 12.732000000000001,</span></span>
<span class="line"><span>          &quot;variance&quot;: 8.637730612244896,</span></span>
<span class="line"><span>          &quot;skewness&quot;: 0.4516049811903419,</span></span>
<span class="line"><span>          &quot;kurtosis&quot;: 2.8615929677997767,</span></span>
<span class="line"><span>          &quot;covariance&quot;: {</span></span>
<span class="line"><span>            &quot;income&quot;: -21093.65836734694,</span></span>
<span class="line"><span>            &quot;poverty&quot;: 8.637730612244896</span></span>
<span class="line"><span>          },</span></span>
<span class="line"><span>          &quot;correlation&quot;: {</span></span>
<span class="line"><span>            &quot;income&quot;: -0.8352655256272504,</span></span>
<span class="line"><span>            &quot;poverty&quot;: 1.0</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>        } ]</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="extended-stats" tabindex="-1"><code>extended_stats</code> <a class="header-anchor" href="#extended-stats" aria-label="Permalink to &quot;\`extended_stats\`&quot;">​</a></h3><p>根据从汇总文档中提取的数值计算统计信息。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GET /exams/_search</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;size&quot;: 0,</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;grades_stats&quot;: { &quot;extended_stats&quot;: { &quot;field&quot;: &quot;grade&quot; } }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>上面的汇总计算了所有文档的成绩统计信息。聚合类型为extended_stats，并且字段设置定义将在其上计算统计信息的文档的数字字段。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;grades_stats&quot;: {</span></span>
<span class="line"><span>      &quot;count&quot;: 2,</span></span>
<span class="line"><span>      &quot;min&quot;: 50.0,</span></span>
<span class="line"><span>      &quot;max&quot;: 100.0,</span></span>
<span class="line"><span>      &quot;avg&quot;: 75.0,</span></span>
<span class="line"><span>      &quot;sum&quot;: 150.0,</span></span>
<span class="line"><span>      &quot;sum_of_squares&quot;: 12500.0,</span></span>
<span class="line"><span>      &quot;variance&quot;: 625.0,</span></span>
<span class="line"><span>      &quot;variance_population&quot;: 625.0,</span></span>
<span class="line"><span>      &quot;variance_sampling&quot;: 1250.0,</span></span>
<span class="line"><span>      &quot;std_deviation&quot;: 25.0,</span></span>
<span class="line"><span>      &quot;std_deviation_population&quot;: 25.0,</span></span>
<span class="line"><span>      &quot;std_deviation_sampling&quot;: 35.35533905932738,</span></span>
<span class="line"><span>      &quot;std_deviation_bounds&quot;: {</span></span>
<span class="line"><span>        &quot;upper&quot;: 125.0,</span></span>
<span class="line"><span>        &quot;lower&quot;: 25.0,</span></span>
<span class="line"><span>        &quot;upper_population&quot;: 125.0,</span></span>
<span class="line"><span>        &quot;lower_population&quot;: 25.0,</span></span>
<span class="line"><span>        &quot;upper_sampling&quot;: 145.71067811865476,</span></span>
<span class="line"><span>        &quot;lower_sampling&quot;: 4.289321881345245</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="string-stats-针对字符串" tabindex="-1"><code>string_stats</code> 针对字符串 <a class="header-anchor" href="#string-stats-针对字符串" aria-label="Permalink to &quot;\`string_stats\` 针对字符串&quot;">​</a></h3><p>用于计算从聚合文档中提取的字符串值的统计信息。这些值可以从特定的关键字字段中检索。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /my-index-000001/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;message_stats&quot;: { &quot;string_stats&quot;: { &quot;field&quot;: &quot;message.keyword&quot; } }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;message_stats&quot;: {</span></span>
<span class="line"><span>      &quot;count&quot;: 5,</span></span>
<span class="line"><span>      &quot;min_length&quot;: 24,</span></span>
<span class="line"><span>      &quot;max_length&quot;: 30,</span></span>
<span class="line"><span>      &quot;avg_length&quot;: 28.8,</span></span>
<span class="line"><span>      &quot;entropy&quot;: 3.94617750050791</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="非单值分析-百分数型" tabindex="-1">非单值分析：百分数型 <a class="header-anchor" href="#非单值分析-百分数型" aria-label="Permalink to &quot;非单值分析：百分数型&quot;">​</a></h2><h3 id="percentiles-百分数范围" tabindex="-1"><code>percentiles</code> 百分数范围 <a class="header-anchor" href="#percentiles-百分数范围" aria-label="Permalink to &quot;\`percentiles\` 百分数范围&quot;">​</a></h3><p>针对从聚合文档中提取的数值计算一个或多个百分位数。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GET latency/_search</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;size&quot;: 0,</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;load_time_outlier&quot;: {</span></span>
<span class="line"><span>      &quot;percentiles&quot;: {</span></span>
<span class="line"><span>        &quot;field&quot;: &quot;load_time&quot; </span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>默认情况下，百分位度量标准将生成一定范围的百分位：[1，5，25，50，75，95，99]。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span> &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;load_time_outlier&quot;: {</span></span>
<span class="line"><span>      &quot;values&quot;: {</span></span>
<span class="line"><span>        &quot;1.0&quot;: 5.0,</span></span>
<span class="line"><span>        &quot;5.0&quot;: 25.0,</span></span>
<span class="line"><span>        &quot;25.0&quot;: 165.0,</span></span>
<span class="line"><span>        &quot;50.0&quot;: 445.0,</span></span>
<span class="line"><span>        &quot;75.0&quot;: 725.0,</span></span>
<span class="line"><span>        &quot;95.0&quot;: 945.0,</span></span>
<span class="line"><span>        &quot;99.0&quot;: 985.0</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="percentile-ranks-百分数排行" tabindex="-1"><code>percentile_ranks</code> 百分数排行 <a class="header-anchor" href="#percentile-ranks-百分数排行" aria-label="Permalink to &quot;\`percentile_ranks\` 百分数排行&quot;">​</a></h3><p>根据从汇总文档中提取的数值计算一个或多个百分位等级。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GET latency/_search</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;size&quot;: 0,</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;load_time_ranks&quot;: {</span></span>
<span class="line"><span>      &quot;percentile_ranks&quot;: {</span></span>
<span class="line"><span>        &quot;field&quot;: &quot;load_time&quot;,   </span></span>
<span class="line"><span>        &quot;values&quot;: [ 500, 600 ]</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span> &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;load_time_ranks&quot;: {</span></span>
<span class="line"><span>      &quot;values&quot;: {</span></span>
<span class="line"><span>        &quot;500.0&quot;: 90.01,</span></span>
<span class="line"><span>        &quot;600.0&quot;: 100.0</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>上述结果表示90.01％的页面加载在500ms内完成，而100％的页面加载在600ms内完成。</p><h2 id="非单值分析-地理位置型" tabindex="-1">非单值分析：地理位置型 <a class="header-anchor" href="#非单值分析-地理位置型" aria-label="Permalink to &quot;非单值分析：地理位置型&quot;">​</a></h2><h3 id="geo-bounds-geo-bounds" tabindex="-1"><code>geo_bounds</code> Geo bounds <a class="header-anchor" href="#geo-bounds-geo-bounds" aria-label="Permalink to &quot;\`geo_bounds\` Geo bounds&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>PUT /museums</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;mappings&quot;: {</span></span>
<span class="line"><span>    &quot;properties&quot;: {</span></span>
<span class="line"><span>      &quot;location&quot;: {</span></span>
<span class="line"><span>        &quot;type&quot;: &quot;geo_point&quot;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>POST /museums/_bulk?refresh</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:1}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;52.374081,4.912350&quot;, &quot;name&quot;: &quot;NEMO Science Museum&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:2}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;52.369219,4.901618&quot;, &quot;name&quot;: &quot;Museum Het Rembrandthuis&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:3}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;52.371667,4.914722&quot;, &quot;name&quot;: &quot;Nederlands Scheepvaartmuseum&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:4}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;51.222900,4.405200&quot;, &quot;name&quot;: &quot;Letterenhuis&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:5}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;48.861111,2.336389&quot;, &quot;name&quot;: &quot;Musée du Louvre&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:6}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;48.860000,2.327000&quot;, &quot;name&quot;: &quot;Musée d&#39;Orsay&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>POST /museums/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;query&quot;: {</span></span>
<span class="line"><span>    &quot;match&quot;: { &quot;name&quot;: &quot;musée&quot; }</span></span>
<span class="line"><span>  },</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;viewport&quot;: {</span></span>
<span class="line"><span>      &quot;geo_bounds&quot;: {</span></span>
<span class="line"><span>        &quot;field&quot;: &quot;location&quot;,    </span></span>
<span class="line"><span>        &quot;wrap_longitude&quot;: true  </span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>上面的汇总展示了如何针对具有商店业务类型的所有文档计算位置字段的边界框</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;viewport&quot;: {</span></span>
<span class="line"><span>      &quot;bounds&quot;: {</span></span>
<span class="line"><span>        &quot;top_left&quot;: {</span></span>
<span class="line"><span>          &quot;lat&quot;: 48.86111099738628,</span></span>
<span class="line"><span>          &quot;lon&quot;: 2.3269999679178</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        &quot;bottom_right&quot;: {</span></span>
<span class="line"><span>          &quot;lat&quot;: 48.85999997612089,</span></span>
<span class="line"><span>          &quot;lon&quot;: 2.3363889567553997</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="geo-centroid-geo-centroid" tabindex="-1"><code>geo_centroid</code> Geo-centroid <a class="header-anchor" href="#geo-centroid-geo-centroid" aria-label="Permalink to &quot;\`geo_centroid\` Geo-centroid&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>PUT /museums</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;mappings&quot;: {</span></span>
<span class="line"><span>    &quot;properties&quot;: {</span></span>
<span class="line"><span>      &quot;location&quot;: {</span></span>
<span class="line"><span>        &quot;type&quot;: &quot;geo_point&quot;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>POST /museums/_bulk?refresh</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:1}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;52.374081,4.912350&quot;, &quot;city&quot;: &quot;Amsterdam&quot;, &quot;name&quot;: &quot;NEMO Science Museum&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:2}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;52.369219,4.901618&quot;, &quot;city&quot;: &quot;Amsterdam&quot;, &quot;name&quot;: &quot;Museum Het Rembrandthuis&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:3}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;52.371667,4.914722&quot;, &quot;city&quot;: &quot;Amsterdam&quot;, &quot;name&quot;: &quot;Nederlands Scheepvaartmuseum&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:4}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;51.222900,4.405200&quot;, &quot;city&quot;: &quot;Antwerp&quot;, &quot;name&quot;: &quot;Letterenhuis&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:5}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;48.861111,2.336389&quot;, &quot;city&quot;: &quot;Paris&quot;, &quot;name&quot;: &quot;Musée du Louvre&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;:{&quot;_id&quot;:6}}</span></span>
<span class="line"><span>{&quot;location&quot;: &quot;48.860000,2.327000&quot;, &quot;city&quot;: &quot;Paris&quot;, &quot;name&quot;: &quot;Musée d&#39;Orsay&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>POST /museums/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;centroid&quot;: {</span></span>
<span class="line"><span>      &quot;geo_centroid&quot;: {</span></span>
<span class="line"><span>        &quot;field&quot;: &quot;location&quot; </span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>上面的汇总显示了如何针对所有具有犯罪类型的盗窃文件计算位置字段的质心。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;centroid&quot;: {</span></span>
<span class="line"><span>      &quot;location&quot;: {</span></span>
<span class="line"><span>        &quot;lat&quot;: 51.00982965203002,</span></span>
<span class="line"><span>        &quot;lon&quot;: 3.9662131341174245</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>      &quot;count&quot;: 6</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="geo-line-geo-line" tabindex="-1"><code>geo_line</code> Geo-Line <a class="header-anchor" href="#geo-line-geo-line" aria-label="Permalink to &quot;\`geo_line\` Geo-Line&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>PUT test</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    &quot;mappings&quot;: {</span></span>
<span class="line"><span>        &quot;dynamic&quot;: &quot;strict&quot;,</span></span>
<span class="line"><span>        &quot;_source&quot;: {</span></span>
<span class="line"><span>            &quot;enabled&quot;: false</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        &quot;properties&quot;: {</span></span>
<span class="line"><span>            &quot;my_location&quot;: {</span></span>
<span class="line"><span>                &quot;type&quot;: &quot;geo_point&quot;</span></span>
<span class="line"><span>            },</span></span>
<span class="line"><span>            &quot;group&quot;: {</span></span>
<span class="line"><span>                &quot;type&quot;: &quot;keyword&quot;</span></span>
<span class="line"><span>            },</span></span>
<span class="line"><span>            &quot;@timestamp&quot;: {</span></span>
<span class="line"><span>                &quot;type&quot;: &quot;date&quot;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>POST /test/_bulk?refresh</span></span>
<span class="line"><span>{&quot;index&quot;: {}}</span></span>
<span class="line"><span>{&quot;my_location&quot;: {&quot;lat&quot;:37.3450570, &quot;lon&quot;: -122.0499820}, &quot;@timestamp&quot;: &quot;2013-09-06T16:00:36&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;: {}}</span></span>
<span class="line"><span>{&quot;my_location&quot;: {&quot;lat&quot;: 37.3451320, &quot;lon&quot;: -122.0499820}, &quot;@timestamp&quot;: &quot;2013-09-06T16:00:37Z&quot;}</span></span>
<span class="line"><span>{&quot;index&quot;: {}}</span></span>
<span class="line"><span>{&quot;my_location&quot;: {&quot;lat&quot;: 37.349283, &quot;lon&quot;: -122.0505010}, &quot;@timestamp&quot;: &quot;2013-09-06T16:00:37Z&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>POST /test/_search?filter_path=aggregations</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;line&quot;: {</span></span>
<span class="line"><span>      &quot;geo_line&quot;: {</span></span>
<span class="line"><span>        &quot;point&quot;: {&quot;field&quot;: &quot;my_location&quot;},</span></span>
<span class="line"><span>        &quot;sort&quot;: {&quot;field&quot;: &quot;@timestamp&quot;}</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>将存储桶中的所有geo_point值聚合到由所选排序字段排序的LineString中。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;line&quot;: {</span></span>
<span class="line"><span>      &quot;type&quot; : &quot;Feature&quot;,</span></span>
<span class="line"><span>      &quot;geometry&quot; : {</span></span>
<span class="line"><span>        &quot;type&quot; : &quot;LineString&quot;,</span></span>
<span class="line"><span>        &quot;coordinates&quot; : [</span></span>
<span class="line"><span>          [</span></span>
<span class="line"><span>            -122.049982,</span></span>
<span class="line"><span>            37.345057</span></span>
<span class="line"><span>          ],</span></span>
<span class="line"><span>          [</span></span>
<span class="line"><span>            -122.050501,</span></span>
<span class="line"><span>            37.349283</span></span>
<span class="line"><span>          ],</span></span>
<span class="line"><span>          [</span></span>
<span class="line"><span>            -122.049982,</span></span>
<span class="line"><span>            37.345132</span></span>
<span class="line"><span>          ]</span></span>
<span class="line"><span>        ]</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>      &quot;properties&quot; : {</span></span>
<span class="line"><span>        &quot;complete&quot; : true</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="非单值分析-top型" tabindex="-1">非单值分析：Top型 <a class="header-anchor" href="#非单值分析-top型" aria-label="Permalink to &quot;非单值分析：Top型&quot;">​</a></h2><h3 id="top-hits-分桶后的top-hits" tabindex="-1"><code>top_hits</code> 分桶后的top hits <a class="header-anchor" href="#top-hits-分桶后的top-hits" aria-label="Permalink to &quot;\`top_hits\` 分桶后的top hits&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /sales/_search?size=0</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;top_tags&quot;: {</span></span>
<span class="line"><span>      &quot;terms&quot;: {</span></span>
<span class="line"><span>        &quot;field&quot;: &quot;type&quot;,</span></span>
<span class="line"><span>        &quot;size&quot;: 3</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>      &quot;aggs&quot;: {</span></span>
<span class="line"><span>        &quot;top_sales_hits&quot;: {</span></span>
<span class="line"><span>          &quot;top_hits&quot;: {</span></span>
<span class="line"><span>            &quot;sort&quot;: [</span></span>
<span class="line"><span>              {</span></span>
<span class="line"><span>                &quot;date&quot;: {</span></span>
<span class="line"><span>                  &quot;order&quot;: &quot;desc&quot;</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>              }</span></span>
<span class="line"><span>            ],</span></span>
<span class="line"><span>            &quot;_source&quot;: {</span></span>
<span class="line"><span>              &quot;includes&quot;: [ &quot;date&quot;, &quot;price&quot; ]</span></span>
<span class="line"><span>            },</span></span>
<span class="line"><span>            &quot;size&quot;: 1</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;top_tags&quot;: {</span></span>
<span class="line"><span>       &quot;doc_count_error_upper_bound&quot;: 0,</span></span>
<span class="line"><span>       &quot;sum_other_doc_count&quot;: 0,</span></span>
<span class="line"><span>       &quot;buckets&quot;: [</span></span>
<span class="line"><span>          {</span></span>
<span class="line"><span>             &quot;key&quot;: &quot;hat&quot;,</span></span>
<span class="line"><span>             &quot;doc_count&quot;: 3,</span></span>
<span class="line"><span>             &quot;top_sales_hits&quot;: {</span></span>
<span class="line"><span>                &quot;hits&quot;: {</span></span>
<span class="line"><span>                   &quot;total&quot; : {</span></span>
<span class="line"><span>                       &quot;value&quot;: 3,</span></span>
<span class="line"><span>                       &quot;relation&quot;: &quot;eq&quot;</span></span>
<span class="line"><span>                   },</span></span>
<span class="line"><span>                   &quot;max_score&quot;: null,</span></span>
<span class="line"><span>                   &quot;hits&quot;: [</span></span>
<span class="line"><span>                      {</span></span>
<span class="line"><span>                         &quot;_index&quot;: &quot;sales&quot;,</span></span>
<span class="line"><span>                         &quot;_type&quot;: &quot;_doc&quot;,</span></span>
<span class="line"><span>                         &quot;_id&quot;: &quot;AVnNBmauCQpcRyxw6ChK&quot;,</span></span>
<span class="line"><span>                         &quot;_source&quot;: {</span></span>
<span class="line"><span>                            &quot;date&quot;: &quot;2015/03/01 00:00:00&quot;,</span></span>
<span class="line"><span>                            &quot;price&quot;: 200</span></span>
<span class="line"><span>                         },</span></span>
<span class="line"><span>                         &quot;sort&quot;: [</span></span>
<span class="line"><span>                            1425168000000</span></span>
<span class="line"><span>                         ],</span></span>
<span class="line"><span>                         &quot;_score&quot;: null</span></span>
<span class="line"><span>                      }</span></span>
<span class="line"><span>                   ]</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>             }</span></span>
<span class="line"><span>          },</span></span>
<span class="line"><span>          {</span></span>
<span class="line"><span>             &quot;key&quot;: &quot;t-shirt&quot;,</span></span>
<span class="line"><span>             &quot;doc_count&quot;: 3,</span></span>
<span class="line"><span>             &quot;top_sales_hits&quot;: {</span></span>
<span class="line"><span>                &quot;hits&quot;: {</span></span>
<span class="line"><span>                   &quot;total&quot; : {</span></span>
<span class="line"><span>                       &quot;value&quot;: 3,</span></span>
<span class="line"><span>                       &quot;relation&quot;: &quot;eq&quot;</span></span>
<span class="line"><span>                   },</span></span>
<span class="line"><span>                   &quot;max_score&quot;: null,</span></span>
<span class="line"><span>                   &quot;hits&quot;: [</span></span>
<span class="line"><span>                      {</span></span>
<span class="line"><span>                         &quot;_index&quot;: &quot;sales&quot;,</span></span>
<span class="line"><span>                         &quot;_type&quot;: &quot;_doc&quot;,</span></span>
<span class="line"><span>                         &quot;_id&quot;: &quot;AVnNBmauCQpcRyxw6ChL&quot;,</span></span>
<span class="line"><span>                         &quot;_source&quot;: {</span></span>
<span class="line"><span>                            &quot;date&quot;: &quot;2015/03/01 00:00:00&quot;,</span></span>
<span class="line"><span>                            &quot;price&quot;: 175</span></span>
<span class="line"><span>                         },</span></span>
<span class="line"><span>                         &quot;sort&quot;: [</span></span>
<span class="line"><span>                            1425168000000</span></span>
<span class="line"><span>                         ],</span></span>
<span class="line"><span>                         &quot;_score&quot;: null</span></span>
<span class="line"><span>                      }</span></span>
<span class="line"><span>                   ]</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>             }</span></span>
<span class="line"><span>          },</span></span>
<span class="line"><span>          {</span></span>
<span class="line"><span>             &quot;key&quot;: &quot;bag&quot;,</span></span>
<span class="line"><span>             &quot;doc_count&quot;: 1,</span></span>
<span class="line"><span>             &quot;top_sales_hits&quot;: {</span></span>
<span class="line"><span>                &quot;hits&quot;: {</span></span>
<span class="line"><span>                   &quot;total&quot; : {</span></span>
<span class="line"><span>                       &quot;value&quot;: 1,</span></span>
<span class="line"><span>                       &quot;relation&quot;: &quot;eq&quot;</span></span>
<span class="line"><span>                   },</span></span>
<span class="line"><span>                   &quot;max_score&quot;: null,</span></span>
<span class="line"><span>                   &quot;hits&quot;: [</span></span>
<span class="line"><span>                      {</span></span>
<span class="line"><span>                         &quot;_index&quot;: &quot;sales&quot;,</span></span>
<span class="line"><span>                         &quot;_type&quot;: &quot;_doc&quot;,</span></span>
<span class="line"><span>                         &quot;_id&quot;: &quot;AVnNBmatCQpcRyxw6ChH&quot;,</span></span>
<span class="line"><span>                         &quot;_source&quot;: {</span></span>
<span class="line"><span>                            &quot;date&quot;: &quot;2015/01/01 00:00:00&quot;,</span></span>
<span class="line"><span>                            &quot;price&quot;: 150</span></span>
<span class="line"><span>                         },</span></span>
<span class="line"><span>                         &quot;sort&quot;: [</span></span>
<span class="line"><span>                            1420070400000</span></span>
<span class="line"><span>                         ],</span></span>
<span class="line"><span>                         &quot;_score&quot;: null</span></span>
<span class="line"><span>                      }</span></span>
<span class="line"><span>                   ]</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>             }</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>       ]</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="top-metrics" tabindex="-1"><code>top_metrics</code> <a class="header-anchor" href="#top-metrics" aria-label="Permalink to &quot;\`top_metrics\`&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /test/_bulk?refresh</span></span>
<span class="line"><span>{&quot;index&quot;: {}}</span></span>
<span class="line"><span>{&quot;s&quot;: 1, &quot;m&quot;: 3.1415}</span></span>
<span class="line"><span>{&quot;index&quot;: {}}</span></span>
<span class="line"><span>{&quot;s&quot;: 2, &quot;m&quot;: 1.0}</span></span>
<span class="line"><span>{&quot;index&quot;: {}}</span></span>
<span class="line"><span>{&quot;s&quot;: 3, &quot;m&quot;: 2.71828}</span></span>
<span class="line"><span>POST /test/_search?filter_path=aggregations</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggs&quot;: {</span></span>
<span class="line"><span>    &quot;tm&quot;: {</span></span>
<span class="line"><span>      &quot;top_metrics&quot;: {</span></span>
<span class="line"><span>        &quot;metrics&quot;: {&quot;field&quot;: &quot;m&quot;},</span></span>
<span class="line"><span>        &quot;sort&quot;: {&quot;s&quot;: &quot;desc&quot;}</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>返回</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>  &quot;aggregations&quot;: {</span></span>
<span class="line"><span>    &quot;tm&quot;: {</span></span>
<span class="line"><span>      &quot;top&quot;: [ {&quot;sort&quot;: [3], &quot;metrics&quot;: {&quot;m&quot;: 2.718280076980591 } } ]</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="参考文章" tabindex="-1">参考文章 <a class="header-anchor" href="#参考文章" aria-label="Permalink to &quot;参考文章&quot;">​</a></h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics.html" target="_blank" rel="noreferrer">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics.html</a></p><p>本文转自 <a href="https://pdai.tech" target="_blank" rel="noreferrer">https://pdai.tech</a>，如有侵权，请联系删除。</p>`,107)]))}const g=n(l,[["render",o]]);export{h as __pageData,g as default};
