import{_ as n,a}from"./chunks/mongo-x-usage-12.CxdYUXqB.js";import{_ as p,c as t,ai as o,o as e}from"./chunks/framework.BrYByd3F.js";const l="/vitepress-blog-template/images/db/mongo/mongo-x-usage-17.png",u="/vitepress-blog-template/images/db/mongo/mongo-x-usage-13.png",i="/vitepress-blog-template/images/db/mongo/mongo-x-usage-14.png",q="/vitepress-blog-template/images/db/mongo/mongo-x-usage-15.png",c="/vitepress-blog-template/images/db/mongo/mongo-x-usage-16.png",y=JSON.parse('{"title":"Mongo入门 - 基本使用：索引和聚合","description":"","frontmatter":{},"headers":[],"relativePath":"db/nosql-mongo/mongo-x-usage-2.md","filePath":"db/nosql-mongo/mongo-x-usage-2.md","lastUpdated":1737706346000}'),r={name:"db/nosql-mongo/mongo-x-usage-2.md"};function d(g,s,h,m,b,_){return e(),t("div",null,s[0]||(s[0]=[o('<h1 id="mongo入门-基本使用-索引和聚合" tabindex="-1">Mongo入门 - 基本使用：索引和聚合 <a class="header-anchor" href="#mongo入门-基本使用-索引和聚合" aria-label="Permalink to &quot;Mongo入门 - 基本使用：索引和聚合&quot;">​</a></h1><blockquote><p>在了解MongoDB的基本CRUD操作后，常用的其它操作还有对字段的索引以及对字段的聚合操作。@pdai</p></blockquote><h2 id="聚合-aggregation-pipline" tabindex="-1">聚合 - Aggregation Pipline <a class="header-anchor" href="#聚合-aggregation-pipline" aria-label="Permalink to &quot;聚合 - Aggregation Pipline&quot;">​</a></h2><blockquote><p>类似于将SQL中的group by + order by + left join ... 等操作管道化。</p></blockquote><h3 id="常规使用" tabindex="-1">常规使用 <a class="header-anchor" href="#常规使用" aria-label="Permalink to &quot;常规使用&quot;">​</a></h3><ul><li>图例理解</li></ul><p><img src="'+n+`" alt=""></p><ul><li>准备数据</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; db.orders.insertMany( [</span></span>
<span class="line"><span>...     { _id: 1, cust_id: &quot;abc1&quot;, ord_date: ISODate(&quot;2012-11-02T17:04:11.102Z&quot;), status: &quot;A&quot;, amount: 50 },</span></span>
<span class="line"><span>...     { _id: 2, cust_id: &quot;xyz1&quot;, ord_date: ISODate(&quot;2013-10-01T17:04:11.102Z&quot;), status: &quot;A&quot;, amount: 100 },</span></span>
<span class="line"><span>...     { _id: 3, cust_id: &quot;xyz1&quot;, ord_date: ISODate(&quot;2013-10-12T17:04:11.102Z&quot;), status: &quot;D&quot;, amount: 25 },</span></span>
<span class="line"><span>...     { _id: 4, cust_id: &quot;xyz1&quot;, ord_date: ISODate(&quot;2013-10-11T17:04:11.102Z&quot;), status: &quot;D&quot;, amount: 125 },</span></span>
<span class="line"><span>...     { _id: 5, cust_id: &quot;abc1&quot;, ord_date: ISODate(&quot;2013-11-12T17:04:11.102Z&quot;), status: &quot;A&quot;, amount: 25 }</span></span>
<span class="line"><span>... ] );</span></span>
<span class="line"><span>{ &quot;acknowledged&quot; : true, &quot;insertedIds&quot; : [ 1, 2, 3, 4, 5 ] }</span></span>
<span class="line"><span>&gt; db.orders.find({})</span></span>
<span class="line"><span>{ &quot;_id&quot; : 1, &quot;cust_id&quot; : &quot;abc1&quot;, &quot;ord_date&quot; : ISODate(&quot;2012-11-02T17:04:11.102Z&quot;), &quot;status&quot; : &quot;A&quot;, &quot;amount&quot; : 50 }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 2, &quot;cust_id&quot; : &quot;xyz1&quot;, &quot;ord_date&quot; : ISODate(&quot;2013-10-01T17:04:11.102Z&quot;), &quot;status&quot; : &quot;A&quot;, &quot;amount&quot; : 100 }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 3, &quot;cust_id&quot; : &quot;xyz1&quot;, &quot;ord_date&quot; : ISODate(&quot;2013-10-12T17:04:11.102Z&quot;), &quot;status&quot; : &quot;D&quot;, &quot;amount&quot; : 25 }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 4, &quot;cust_id&quot; : &quot;xyz1&quot;, &quot;ord_date&quot; : ISODate(&quot;2013-10-11T17:04:11.102Z&quot;), &quot;status&quot; : &quot;D&quot;, &quot;amount&quot; : 125 }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 5, &quot;cust_id&quot; : &quot;abc1&quot;, &quot;ord_date&quot; : ISODate(&quot;2013-11-12T17:04:11.102Z&quot;), &quot;status&quot; : &quot;A&quot;, &quot;amount&quot; : 25 }</span></span>
<span class="line"><span>&gt;</span></span></code></pre></div><ul><li>聚合操作</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; db.orders.aggregate([</span></span>
<span class="line"><span>...                      { $match: { status: &quot;A&quot; } },</span></span>
<span class="line"><span>...                      { $group: { _id: &quot;$cust_id&quot;, total: { $sum: &quot;$amount&quot; } } },</span></span>
<span class="line"><span>...                      { $sort: { total: -1 } }</span></span>
<span class="line"><span>...                    ])</span></span>
<span class="line"><span>{ &quot;_id&quot; : &quot;xyz1&quot;, &quot;total&quot; : 100 }</span></span>
<span class="line"><span>{ &quot;_id&quot; : &quot;abc1&quot;, &quot;total&quot; : 75 }</span></span></code></pre></div><p>官网还有两个例子：</p><ul><li><a href="https://docs.mongodb.com/v3.6/tutorial/aggregation-zip-code-data-set/" target="_blank" rel="noreferrer">Aggregation with the Zip Code Data Set在新窗口打开</a></li><li><a href="https://docs.mongodb.com/v3.6/tutorial/aggregation-with-user-preference-data/" target="_blank" rel="noreferrer">Aggregation with User Preference Data在新窗口打开</a></li></ul><h3 id="pipline操作" tabindex="-1">Pipline操作 <a class="header-anchor" href="#pipline操作" aria-label="Permalink to &quot;Pipline操作&quot;">​</a></h3><p>MongoDB的聚合管道（Pipline）将MongoDB文档在一个阶段（Stage）处理完毕后将结果传递给下一个阶段（Stage）处理。<strong>阶段（Stage）操作是可以重复的</strong>。</p><p>表达式：处理输入文档并输出。表达式是无状态的，只能用于计算当前聚合管道的文档，不能处理其它的文档。</p><p>这里我们介绍一下聚合框架中常用的几个Stages：</p><ul><li><code>$project</code>：修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。</li><li><code>$match</code>：用于过滤数据，只输出符合条件的文档。$match使用MongoDB的标准查询操作。</li><li><code>$limit</code>：用来限制MongoDB聚合管道返回的文档数。</li><li><code>$skip</code>：在聚合管道中跳过指定数量的文档，并返回余下的文档。</li><li><code>$unwind</code>：将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。</li><li><code>$group</code>：将集合中的文档分组，可用于统计结果。</li><li><code>$sort</code>：将输入文档排序后输出。</li><li><code>$geoNear</code>：输出接近某一地理位置的有序文档。</li><li><code>$bucket</code>: 分组（分桶）计算。</li><li><code>$facet</code> : 多次分组计算。</li><li><code>$out</code>: 将结果集输出，必须是Pipline最后一个Stage。</li></ul><p>举几个例子</p><ul><li>$project</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; db.orders.aggregate(</span></span>
<span class="line"><span>...     { $project : {</span></span>
<span class="line"><span>...         _id : 0 , // 默认不显示_id</span></span>
<span class="line"><span>...         cust_id : 1 ,</span></span>
<span class="line"><span>...         status : 1</span></span>
<span class="line"><span>...     }});</span></span>
<span class="line"><span>{ &quot;cust_id&quot; : &quot;abc1&quot;, &quot;status&quot; : &quot;A&quot; }</span></span>
<span class="line"><span>{ &quot;cust_id&quot; : &quot;xyz1&quot;, &quot;status&quot; : &quot;A&quot; }</span></span>
<span class="line"><span>{ &quot;cust_id&quot; : &quot;xyz1&quot;, &quot;status&quot; : &quot;D&quot; }</span></span>
<span class="line"><span>{ &quot;cust_id&quot; : &quot;xyz1&quot;, &quot;status&quot; : &quot;D&quot; }</span></span>
<span class="line"><span>{ &quot;cust_id&quot; : &quot;abc1&quot;, &quot;status&quot; : &quot;A&quot; }</span></span>
<span class="line"><span>&gt;</span></span></code></pre></div><ul><li>$skip</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span> db.orders.aggregate(</span></span>
<span class="line"><span>...     { $skip : 4 });</span></span>
<span class="line"><span>{ &quot;_id&quot; : 5, &quot;cust_id&quot; : &quot;abc1&quot;, &quot;ord_date&quot; : ISODate(&quot;2013-11-12T17:04:11.102Z&quot;), &quot;status&quot; : &quot;A&quot;, &quot;amount&quot; : 25 }</span></span>
<span class="line"><span>&gt;</span></span></code></pre></div><ul><li>$unwind</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; db.inventory2.insertOne({ &quot;_id&quot; : 1, &quot;item&quot; : &quot;ABC1&quot;, sizes: [ &quot;S&quot;, &quot;M&quot;, &quot;L&quot;] })</span></span>
<span class="line"><span>{ &quot;acknowledged&quot; : true, &quot;insertedId&quot; : 1 }</span></span>
<span class="line"><span>&gt; db.inventory2.aggregate( [ { $unwind : &quot;$sizes&quot; } ] )</span></span>
<span class="line"><span>{ &quot;_id&quot; : 1, &quot;item&quot; : &quot;ABC1&quot;, &quot;sizes&quot; : &quot;S&quot; }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 1, &quot;item&quot; : &quot;ABC1&quot;, &quot;sizes&quot; : &quot;M&quot; }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 1, &quot;item&quot; : &quot;ABC1&quot;, &quot;sizes&quot; : &quot;L&quot; }</span></span></code></pre></div><ul><li>$bucket</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; db.artwork.insertMany([</span></span>
<span class="line"><span>... { &quot;_id&quot; : 1, &quot;title&quot; : &quot;The Pillars of Society&quot;, &quot;artist&quot; : &quot;Grosz&quot;, &quot;year&quot; : 1926,</span></span>
<span class="line"><span>...     &quot;price&quot; : NumberDecimal(&quot;199.99&quot;) },</span></span>
<span class="line"><span>... { &quot;_id&quot; : 2, &quot;title&quot; : &quot;Melancholy III&quot;, &quot;artist&quot; : &quot;Munch&quot;, &quot;year&quot; : 1902,</span></span>
<span class="line"><span>...     &quot;price&quot; : NumberDecimal(&quot;280.00&quot;) },</span></span>
<span class="line"><span>... { &quot;_id&quot; : 3, &quot;title&quot; : &quot;Dancer&quot;, &quot;artist&quot; : &quot;Miro&quot;, &quot;year&quot; : 1925,</span></span>
<span class="line"><span>...     &quot;price&quot; : NumberDecimal(&quot;76.04&quot;) },</span></span>
<span class="line"><span>... { &quot;_id&quot; : 4, &quot;title&quot; : &quot;The Great Wave off Kanagawa&quot;, &quot;artist&quot; : &quot;Hokusai&quot;,</span></span>
<span class="line"><span>...     &quot;price&quot; : NumberDecimal(&quot;167.30&quot;) },</span></span>
<span class="line"><span>... { &quot;_id&quot; : 5, &quot;title&quot; : &quot;The Persistence of Memory&quot;, &quot;artist&quot; : &quot;Dali&quot;, &quot;year&quot; : 1931,</span></span>
<span class="line"><span>...     &quot;price&quot; : NumberDecimal(&quot;483.00&quot;) },</span></span>
<span class="line"><span>... { &quot;_id&quot; : 6, &quot;title&quot; : &quot;Composition VII&quot;, &quot;artist&quot; : &quot;Kandinsky&quot;, &quot;year&quot; : 1913,</span></span>
<span class="line"><span>...     &quot;price&quot; : NumberDecimal(&quot;385.00&quot;) },</span></span>
<span class="line"><span>... { &quot;_id&quot; : 7, &quot;title&quot; : &quot;The Scream&quot;, &quot;artist&quot; : &quot;Munch&quot;, &quot;year&quot; : 1893 },</span></span>
<span class="line"><span>... { &quot;_id&quot; : 8, &quot;title&quot; : &quot;Blue Flower&quot;, &quot;artist&quot; : &quot;O&#39;Keefe&quot;, &quot;year&quot; : 1918,</span></span>
<span class="line"><span>...     &quot;price&quot; : NumberDecimal(&quot;118.42&quot;) }</span></span>
<span class="line"><span>... ])</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>        &quot;acknowledged&quot; : true,</span></span>
<span class="line"><span>        &quot;insertedIds&quot; : [</span></span>
<span class="line"><span>                1,</span></span>
<span class="line"><span>                2,</span></span>
<span class="line"><span>                3,</span></span>
<span class="line"><span>                4,</span></span>
<span class="line"><span>                5,</span></span>
<span class="line"><span>                6,</span></span>
<span class="line"><span>                7,</span></span>
<span class="line"><span>                8</span></span>
<span class="line"><span>        ]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>&gt; db.artwork.find({})</span></span>
<span class="line"><span>{ &quot;_id&quot; : 1, &quot;title&quot; : &quot;The Pillars of Society&quot;, &quot;artist&quot; : &quot;Grosz&quot;, &quot;year&quot; : 1926, &quot;price&quot; : NumberDecimal(&quot;199.99&quot;) }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 2, &quot;title&quot; : &quot;Melancholy III&quot;, &quot;artist&quot; : &quot;Munch&quot;, &quot;year&quot; : 1902, &quot;price&quot; : NumberDecimal(&quot;280.00&quot;) }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 3, &quot;title&quot; : &quot;Dancer&quot;, &quot;artist&quot; : &quot;Miro&quot;, &quot;year&quot; : 1925, &quot;price&quot; : NumberDecimal(&quot;76.04&quot;) }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 4, &quot;title&quot; : &quot;The Great Wave off Kanagawa&quot;, &quot;artist&quot; : &quot;Hokusai&quot;, &quot;price&quot; : NumberDecimal(&quot;167.30&quot;) }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 5, &quot;title&quot; : &quot;The Persistence of Memory&quot;, &quot;artist&quot; : &quot;Dali&quot;, &quot;year&quot; : 1931, &quot;price&quot; : NumberDecimal(&quot;483.00&quot;) }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 6, &quot;title&quot; : &quot;Composition VII&quot;, &quot;artist&quot; : &quot;Kandinsky&quot;, &quot;year&quot; : 1913, &quot;price&quot; : NumberDecimal(&quot;385.00&quot;) }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 7, &quot;title&quot; : &quot;The Scream&quot;, &quot;artist&quot; : &quot;Munch&quot;, &quot;year&quot; : 1893 } // 注意这里没有price，聚合结果中为Others</span></span>
<span class="line"><span>{ &quot;_id&quot; : 8, &quot;title&quot; : &quot;Blue Flower&quot;, &quot;artist&quot; : &quot;O&#39;Keefe&quot;, &quot;year&quot; : 1918, &quot;price&quot; : NumberDecimal(&quot;118.42&quot;) }</span></span>
<span class="line"><span>&gt; db.artwork.aggregate( [</span></span>
<span class="line"><span>...   {</span></span>
<span class="line"><span>...     $bucket: {</span></span>
<span class="line"><span>...       groupBy: &quot;$price&quot;,</span></span>
<span class="line"><span>...       boundaries: [ 0, 200, 400 ],</span></span>
<span class="line"><span>...       default: &quot;Other&quot;,</span></span>
<span class="line"><span>...       output: {</span></span>
<span class="line"><span>...         &quot;count&quot;: { $sum: 1 },</span></span>
<span class="line"><span>...         &quot;titles&quot; : { $push: &quot;$title&quot; }</span></span>
<span class="line"><span>...       }</span></span>
<span class="line"><span>...     }</span></span>
<span class="line"><span>...   }</span></span>
<span class="line"><span>... ] )</span></span>
<span class="line"><span>{ &quot;_id&quot; : 0, &quot;count&quot; : 4, &quot;titles&quot; : [ &quot;The Pillars of Society&quot;, &quot;Dancer&quot;, &quot;The Great Wave off Kanagawa&quot;, &quot;Blue Flower&quot; ] }</span></span>
<span class="line"><span>{ &quot;_id&quot; : 200, &quot;count&quot; : 2, &quot;titles&quot; : [ &quot;Melancholy III&quot;, &quot;Composition VII&quot; ] }</span></span>
<span class="line"><span>{ &quot;_id&quot; : &quot;Other&quot;, &quot;count&quot; : 2, &quot;titles&quot; : [ &quot;The Persistence of Memory&quot;, &quot;The Scream&quot; ] }</span></span></code></pre></div><ul><li>$bucket + $facet</li></ul><blockquote><p>非常常用！</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>db.artwork.aggregate( [</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    $facet: {</span></span>
<span class="line"><span>      &quot;price&quot;: [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          $bucket: {</span></span>
<span class="line"><span>              groupBy: &quot;$price&quot;,</span></span>
<span class="line"><span>              boundaries: [ 0, 200, 400 ],</span></span>
<span class="line"><span>              default: &quot;Other&quot;,</span></span>
<span class="line"><span>              output: {</span></span>
<span class="line"><span>                &quot;count&quot;: { $sum: 1 },</span></span>
<span class="line"><span>                &quot;artwork&quot; : { $push: { &quot;title&quot;: &quot;$title&quot;, &quot;price&quot;: &quot;$price&quot; } }</span></span>
<span class="line"><span>              }</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      ],</span></span>
<span class="line"><span>      &quot;year&quot;: [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          $bucket: {</span></span>
<span class="line"><span>            groupBy: &quot;$year&quot;,</span></span>
<span class="line"><span>            boundaries: [ 1890, 1910, 1920, 1940 ],</span></span>
<span class="line"><span>            default: &quot;Unknown&quot;,</span></span>
<span class="line"><span>            output: {</span></span>
<span class="line"><span>              &quot;count&quot;: { $sum: 1 },</span></span>
<span class="line"><span>              &quot;artwork&quot;: { $push: { &quot;title&quot;: &quot;$title&quot;, &quot;year&quot;: &quot;$year&quot; } }</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      ]</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>] )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// 输出</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;year&quot; : [</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      &quot;_id&quot; : 1890,</span></span>
<span class="line"><span>      &quot;count&quot; : 2,</span></span>
<span class="line"><span>      &quot;artwork&quot; : [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;Melancholy III&quot;,</span></span>
<span class="line"><span>          &quot;year&quot; : 1902</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;The Scream&quot;,</span></span>
<span class="line"><span>          &quot;year&quot; : 1893</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      ]</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      &quot;_id&quot; : 1910,</span></span>
<span class="line"><span>      &quot;count&quot; : 2,</span></span>
<span class="line"><span>      &quot;artwork&quot; : [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;Composition VII&quot;,</span></span>
<span class="line"><span>          &quot;year&quot; : 1913</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;Blue Flower&quot;,</span></span>
<span class="line"><span>          &quot;year&quot; : 1918</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      ]</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      &quot;_id&quot; : 1920,</span></span>
<span class="line"><span>      &quot;count&quot; : 3,</span></span>
<span class="line"><span>      &quot;artwork&quot; : [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;The Pillars of Society&quot;,</span></span>
<span class="line"><span>          &quot;year&quot; : 1926</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;Dancer&quot;,</span></span>
<span class="line"><span>          &quot;year&quot; : 1925</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;The Persistence of Memory&quot;,</span></span>
<span class="line"><span>          &quot;year&quot; : 1931</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      ]</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      // Includes the document without a year, e.g., _id: 4</span></span>
<span class="line"><span>      &quot;_id&quot; : &quot;Unknown&quot;,</span></span>
<span class="line"><span>      &quot;count&quot; : 1,</span></span>
<span class="line"><span>      &quot;artwork&quot; : [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;The Great Wave off Kanagawa&quot;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      ]</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  ],</span></span>
<span class="line"><span>      &quot;price&quot; : [</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      &quot;_id&quot; : 0,</span></span>
<span class="line"><span>      &quot;count&quot; : 4,</span></span>
<span class="line"><span>      &quot;artwork&quot; : [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;The Pillars of Society&quot;,</span></span>
<span class="line"><span>          &quot;price&quot; : NumberDecimal(&quot;199.99&quot;)</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;Dancer&quot;,</span></span>
<span class="line"><span>          &quot;price&quot; : NumberDecimal(&quot;76.04&quot;)</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;The Great Wave off Kanagawa&quot;,</span></span>
<span class="line"><span>          &quot;price&quot; : NumberDecimal(&quot;167.30&quot;)</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;Blue Flower&quot;,</span></span>
<span class="line"><span>          &quot;price&quot; : NumberDecimal(&quot;118.42&quot;)</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      ]</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      &quot;_id&quot; : 200,</span></span>
<span class="line"><span>      &quot;count&quot; : 2,</span></span>
<span class="line"><span>      &quot;artwork&quot; : [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;Melancholy III&quot;,</span></span>
<span class="line"><span>          &quot;price&quot; : NumberDecimal(&quot;280.00&quot;)</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;Composition VII&quot;,</span></span>
<span class="line"><span>          &quot;price&quot; : NumberDecimal(&quot;385.00&quot;)</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      ]</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      // Includes the document without a price, e.g., _id: 7</span></span>
<span class="line"><span>      &quot;_id&quot; : &quot;Other&quot;,</span></span>
<span class="line"><span>      &quot;count&quot; : 2,</span></span>
<span class="line"><span>      &quot;artwork&quot; : [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;The Persistence of Memory&quot;,</span></span>
<span class="line"><span>          &quot;price&quot; : NumberDecimal(&quot;483.00&quot;)</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          &quot;title&quot; : &quot;The Scream&quot;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      ]</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  ]</span></span>
<span class="line"><span>}</span></span></code></pre></div><blockquote><p>聚合操作使用的比较频繁，在实际的工作中可以参考<a href="https://docs.mongodb.com/v3.6/reference/operator/aggregation-pipeline/" target="_blank" rel="noreferrer">官方文档 - Aggregation Pipeline Stages在新窗口打开</a>。</p></blockquote><p><img src="`+l+`" alt=""></p><h3 id="aggregation-options参数" tabindex="-1">Aggregation Options参数 <a class="header-anchor" href="#aggregation-options参数" aria-label="Permalink to &quot;Aggregation Options参数&quot;">​</a></h3><blockquote><p>举一个explain参数为例，更多的相关Options可以参考官方文档，<a href="https://docs.mongodb.com/v3.6/reference/method/db.collection.aggregate/" target="_blank" rel="noreferrer">Aggregrate相关配置在新窗口打开</a></p></blockquote><ul><li>explain</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; db.orders.aggregate(</span></span>
<span class="line"><span>...                      [</span></span>
<span class="line"><span>...                        { $match: { status: &quot;A&quot; } },</span></span>
<span class="line"><span>...                        { $group: { _id: &quot;$cust_id&quot;, total: { $sum: &quot;$amount&quot; } } },</span></span>
<span class="line"><span>...                        { $sort: { total: -1 } }</span></span>
<span class="line"><span>...                      ],</span></span>
<span class="line"><span>...                      {</span></span>
<span class="line"><span>...                        explain: true</span></span>
<span class="line"><span>...                      }</span></span>
<span class="line"><span>...                    )</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>        &quot;serverInfo&quot; : {</span></span>
<span class="line"><span>                &quot;host&quot; : &quot;pdai&quot;,</span></span>
<span class="line"><span>                &quot;port&quot; : 27017,</span></span>
<span class="line"><span>                &quot;version&quot; : &quot;3.6.19&quot;,</span></span>
<span class="line"><span>                &quot;gitVersion&quot; : &quot;41b289ff734a926e784d6ab42c3129f59f40d5b4&quot;</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        &quot;stages&quot; : [</span></span>
<span class="line"><span>                {</span></span>
<span class="line"><span>                        &quot;$cursor&quot; : {</span></span>
<span class="line"><span>                                &quot;query&quot; : {</span></span>
<span class="line"><span>                                        &quot;status&quot; : &quot;A&quot;</span></span>
<span class="line"><span>                                },</span></span>
<span class="line"><span>                                &quot;fields&quot; : {</span></span>
<span class="line"><span>                                        &quot;amount&quot; : 1,</span></span>
<span class="line"><span>                                        &quot;cust_id&quot; : 1,</span></span>
<span class="line"><span>                                        &quot;_id&quot; : 0</span></span>
<span class="line"><span>                                },</span></span>
<span class="line"><span>                                &quot;queryPlanner&quot; : {</span></span>
<span class="line"><span>                                        &quot;plannerVersion&quot; : 1,</span></span>
<span class="line"><span>                                        &quot;namespace&quot; : &quot;testdb.orders&quot;,</span></span>
<span class="line"><span>                                        &quot;indexFilterSet&quot; : false,</span></span>
<span class="line"><span>                                        &quot;parsedQuery&quot; : {</span></span>
<span class="line"><span>                                                &quot;status&quot; : {</span></span>
<span class="line"><span>                                                        &quot;$eq&quot; : &quot;A&quot;</span></span>
<span class="line"><span>                                                }</span></span>
<span class="line"><span>                                        },</span></span>
<span class="line"><span>                                        &quot;winningPlan&quot; : {</span></span>
<span class="line"><span>                                                &quot;stage&quot; : &quot;COLLSCAN&quot;,</span></span>
<span class="line"><span>                                                &quot;filter&quot; : {</span></span>
<span class="line"><span>                                                        &quot;status&quot; : {</span></span>
<span class="line"><span>                                                                &quot;$eq&quot; : &quot;A&quot;</span></span>
<span class="line"><span>                                                        }</span></span>
<span class="line"><span>                                                },</span></span>
<span class="line"><span>                                                &quot;direction&quot; : &quot;forward&quot;</span></span>
<span class="line"><span>                                        },</span></span>
<span class="line"><span>                                        &quot;rejectedPlans&quot; : [ ]</span></span>
<span class="line"><span>                                }</span></span>
<span class="line"><span>                        }</span></span>
<span class="line"><span>                },</span></span>
<span class="line"><span>                {</span></span>
<span class="line"><span>                        &quot;$group&quot; : {</span></span>
<span class="line"><span>                                &quot;_id&quot; : &quot;$cust_id&quot;,</span></span>
<span class="line"><span>                                &quot;total&quot; : {</span></span>
<span class="line"><span>                                        &quot;$sum&quot; : &quot;$amount&quot;</span></span>
<span class="line"><span>                                }</span></span>
<span class="line"><span>                        }</span></span>
<span class="line"><span>                },</span></span>
<span class="line"><span>                {</span></span>
<span class="line"><span>                        &quot;$sort&quot; : {</span></span>
<span class="line"><span>                                &quot;sortKey&quot; : {</span></span>
<span class="line"><span>                                        &quot;total&quot; : -1</span></span>
<span class="line"><span>                                }</span></span>
<span class="line"><span>                        }</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>        ],</span></span>
<span class="line"><span>        &quot;ok&quot; : 1</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="聚合-map-reduce" tabindex="-1">聚合 - Map Reduce <a class="header-anchor" href="#聚合-map-reduce" aria-label="Permalink to &quot;聚合 - Map Reduce&quot;">​</a></h2><ul><li>图例理解</li></ul><p><img src="`+a+`" alt=""></p><h3 id="官网给了个例子" tabindex="-1">官网给了个例子 <a class="header-anchor" href="#官网给了个例子" aria-label="Permalink to &quot;官网给了个例子&quot;">​</a></h3><ul><li>准备数据</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>     _id: ObjectId(&quot;50a8240b927d5d8b5891743c&quot;),</span></span>
<span class="line"><span>     cust_id: &quot;abc123&quot;,</span></span>
<span class="line"><span>     ord_date: new Date(&quot;Oct 04, 2012&quot;),</span></span>
<span class="line"><span>     status: &#39;A&#39;,</span></span>
<span class="line"><span>     price: 25,</span></span>
<span class="line"><span>     items: [ { sku: &quot;mmm&quot;, qty: 5, price: 2.5 },</span></span>
<span class="line"><span>              { sku: &quot;nnn&quot;, qty: 5, price: 2.5 } ]</span></span>
<span class="line"><span>}</span></span></code></pre></div><ul><li>计算每个顾客总花费：</li></ul><p>map</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>var mapFunction1 = function() {</span></span>
<span class="line"><span>                       emit(this.cust_id, this.price);</span></span>
<span class="line"><span>                   };</span></span></code></pre></div><p>reduce</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>var reduceFunction1 = function(keyCustId, valuesPrices) {</span></span>
<span class="line"><span>                          return Array.sum(valuesPrices);</span></span>
<span class="line"><span>                      };</span></span></code></pre></div><p>out</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>db.orders.mapReduce(</span></span>
<span class="line"><span>                     mapFunction1,</span></span>
<span class="line"><span>                     reduceFunction1,</span></span>
<span class="line"><span>                     { out: &quot;map_reduce_example&quot; }</span></span>
<span class="line"><span>                   )</span></span></code></pre></div><ul><li>计算每个订单中Items的均价</li></ul><p>map</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>var mapFunction2 = function() {</span></span>
<span class="line"><span>                       for (var idx = 0; idx &lt; this.items.length; idx++) {</span></span>
<span class="line"><span>                           var key = this.items[idx].sku;</span></span>
<span class="line"><span>                           var value = {</span></span>
<span class="line"><span>                                         count: 1,</span></span>
<span class="line"><span>                                         qty: this.items[idx].qty</span></span>
<span class="line"><span>                                       };</span></span>
<span class="line"><span>                           emit(key, value);</span></span>
<span class="line"><span>                       }</span></span>
<span class="line"><span>                    };</span></span></code></pre></div><p>reduce</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>var reduceFunction2 = function(keySKU, countObjVals) {</span></span>
<span class="line"><span>                     reducedVal = { count: 0, qty: 0 };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                     for (var idx = 0; idx &lt; countObjVals.length; idx++) {</span></span>
<span class="line"><span>                         reducedVal.count += countObjVals[idx].count;</span></span>
<span class="line"><span>                         reducedVal.qty += countObjVals[idx].qty;</span></span>
<span class="line"><span>                     }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                     return reducedVal;</span></span>
<span class="line"><span>                  };</span></span></code></pre></div><p>finalize</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>var finalizeFunction2 = function (key, reducedVal) {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                       reducedVal.avg = reducedVal.qty/reducedVal.count;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                       return reducedVal;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                    };</span></span></code></pre></div><h2 id="索引" tabindex="-1">索引 <a class="header-anchor" href="#索引" aria-label="Permalink to &quot;索引&quot;">​</a></h2><p>索引即为提升查询等的效率，默认是对_id进行索引的。</p><h3 id="图例理解" tabindex="-1">图例理解 <a class="header-anchor" href="#图例理解" aria-label="Permalink to &quot;图例理解&quot;">​</a></h3><p>以对users中score进行索引时查询的效果</p><p><img src="`+u+'" alt=""></p><h3 id="索引的类型" tabindex="-1">索引的类型 <a class="header-anchor" href="#索引的类型" aria-label="Permalink to &quot;索引的类型&quot;">​</a></h3><p>对于索引，这里简单介绍下常用的类型，其它类型和例子可以参考<a href="https://docs.mongodb.com/v3.6/indexes/" target="_blank" rel="noreferrer">官网文档 - 索引在新窗口打开</a></p><ul><li>单一索引</li></ul><p><img src="'+i+'" alt=""></p><ul><li>复合索引</li></ul><p><img src="'+q+'" alt=""></p><ul><li>多键索引</li></ul><p><img src="'+c+'" alt=""></p><h3 id="对索引的操作" tabindex="-1">对索引的操作 <a class="header-anchor" href="#对索引的操作" aria-label="Permalink to &quot;对索引的操作&quot;">​</a></h3><ul><li>查看集合索引</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>db.col.getIndexes()</span></span></code></pre></div><ul><li>查看集合索引大小</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>db.col.totalIndexSize()</span></span></code></pre></div><ul><li>删除集合所有索引</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>db.col.dropIndexes()</span></span></code></pre></div><ul><li>删除集合指定索引</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>db.col.dropIndex(&quot;索引名称&quot;)</span></span></code></pre></div><p>本文转自 <a href="https://pdai.tech" target="_blank" rel="noreferrer">https://pdai.tech</a>，如有侵权，请联系删除。</p>',79)]))}const f=p(r,[["render",d]]);export{y as __pageData,f as default};
